<!DOCTYPE html>
<html>
    <head>
        <title>mapCanvas Example</title>
    </head>
    <body>
        <canvas id="mapCanvas" width="600" height="600"></canvas>
        <canvas id="gameCanvas" width="600" height="600"></canvas>

        <script>
            // JavaScript code for interacting with the mapCanvas will go here
            const mapCanvas = document.getElementById("mapCanvas");
            const mapCtx = mapCanvas.getContext("2d");

            const gameCanvas = document.getElementById("gameCanvas");
            const gameCtx = gameCanvas.getContext("2d");

            map =
                "1110001111\n0      1 1\n0      1 1\n0      1 1\n1      1 1\n22222  2 1\n1        1\n1        1\n1        1\n0000000000";

            lines = map.split("\n");
            tileSize = mapCanvas.height / lines.length;

            function projectMapToCanvas(map) {
                for (let row = 0; row < lines.length; row++) {
                    for (let col = 0; col < lines[row].length; col++) {
                        const char = lines[row][col];

                        switch (char) {
                            case " ":
                                mapCtx.fillStyle = "white";
                                break;
                            case "0":
                                mapCtx.fillStyle = "green";
                                break;
                            case "1":
                                mapCtx.fillStyle = "blue";
                                break;
                            case "2":
                                mapCtx.fillStyle = "red";
                                break;
                        }

                        mapCtx.fillRect(
                            col * tileSize,
                            row * tileSize,
                            tileSize,
                            tileSize
                        );
                    }
                }
            }

            function drawPlayer(x, y, map) {
                const playerSize = 4; // Size of the player pixel
                mapCtx.fillStyle = "red"; // Color of the player
                mapCtx.fillRect(
                    x * tileSize - playerSize / 2,
                    y * tileSize - playerSize / 2,
                    playerSize,
                    playerSize
                );
            }

            playerX = 1.7;
            playerY = 1.5;
            playerAngle = 1;
            const fov = Math.PI / 3.0;

            function getValueFromMap(map, x, y) {
                const ys = map.split("\n");

                if (y >= 0 && y < ys.length && x >= 0 && x < ys[y].length) {
                    return ys[y][x];
                }

                return null;
            }

            const maxDistance = lines.length * 1.5;

            function castRay(playerX, playerY, playerAngle) {
                const rayX = playerX;
                const rayY = playerY;

                mapCtx.fillStyle = "black"; // Color for the ray

                for (
                    let distance = 0;
                    distance < maxDistance;
                    distance += 0.05
                ) {
                    const testX = rayX + Math.cos(playerAngle) * distance;
                    const testY = rayY + Math.sin(playerAngle) * distance;

                    mapValue = getValueFromMap(
                        map,
                        Math.floor(testX),
                        Math.floor(testY)
                    );

                    if (mapValue != " ") {
                        return [distance, mapValue];
                        break;
                    }

                    mapCtx.fillRect(testX * tileSize, testY * tileSize, 1, 1);
                }
                return null;
            }

            function drawPlayerPerspective(playerX, playerY, playerAngle, fov) {
                const gameWidth = 200;
                const canvasScale = gameCanvas.width / gameWidth;

                for (i = 0; i < gameWidth; i++) {
                    angle = playerAngle - fov / 2 + fov * (i / gameWidth);
                    result = castRay(playerX, playerY, angle);

                    if (result != null) {
                        distance = result[0];
                        hitObject = result[1];

                        fisheye_fix = Math.cos(angle - playerAngle);
                        wallHeight =
                            gameCanvas.height / (distance * fisheye_fix);

                        intensity = 1 - distance / maxDistance;

                        switch (hitObject) {
                            case "0":
                                gameCtx.fillStyle = `rgb(0, ${
                                    255 * intensity
                                }, 0)`;
                                break;
                            case "1":
                                gameCtx.fillStyle = `rgb(0, 0, ${
                                    255 * intensity
                                })`;
                                break;
                            case "2":
                                gameCtx.fillStyle = `rgb(${
                                    255 * intensity
                                }, 0, 0)`;
                                break;
                        }

                        gameCtx.fillRect(
                            i * canvasScale,
                            (gameCanvas.height - wallHeight) / 2,
                            canvasScale,
                            wallHeight
                        );
                    }
                }
            }

            function clearCanvas(canvas, context) {
                context.clearRect(0, 0, canvas.width, canvas.height);
            }

            function sleep(ms) {
                return new Promise((resolve) => setTimeout(resolve, ms));
            }

            async function drawScene() {
                clearCanvas(gameCanvas, gameCtx);
                clearCanvas(mapCanvas, mapCtx);

                gameCtx.fillStyle = "black";
                gameCtx.fillRect(0, 0, gameCanvas.width, gameCanvas.height);

                projectMapToCanvas(map);
                drawPlayer(playerX, playerY);

                drawPlayerPerspective(playerX, playerY, playerAngle, fov);

                await sleep(20);
            }

            async function gameLoop() {
                while (true) {
                    await drawScene();
                }
            }

            document.addEventListener("keydown", (event) => {
                const walkSpeed = 0.2;
                const turnSpeed = 0.1;
                switch (event.key) {
                    case "w":
                        playerX += walkSpeed * Math.cos(playerAngle);
                        playerY += walkSpeed * Math.sin(playerAngle);
                        break;
                    case "s":
                        playerX += -walkSpeed * Math.cos(playerAngle);
                        playerY += -walkSpeed * Math.sin(playerAngle);
                        break;
                    case "a":
                        playerAngle -= turnSpeed;
                        break;
                    case "d":
                        playerAngle += turnSpeed;
                        break;
                }
            });

            gameLoop();
        </script>
    </body>
</html>
